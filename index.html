<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Warfie</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/4.5.1/pixi.min.js"></script>
  <!--<script type="text/javascript" src="lib/pixis.js"></script>-->
<script src="https://unpkg.com/jquery"></script>
  <script type="text/javascript" src="lib/tools.js"></script>
  <script type="text/javascript" src="lib/webcamz.js"></script>
  <script type="text/javascript" src="lib/color.js"></script>
  
  <style>


  #download {
    
  }
body, html {
  margin: 0;
  background-color: black;
}
  #canvasholder {
    position: relative;
    width: 100%;
    /*margin-left: 10%;*/
    margin-top: 40px;

    /*Výška musí být nastavená!!!*/
    height: 600px;
   height: 50vw;
    z-index: 5;
  }
  #mycamera {
    position: absolute;
    background-color: black;
    z-index: -1;
  }
  </style>


</head>

<body>
  <a id="dl" download="Stopidet.png" style="color: blue;">Download Canvas</a>
    <div id="canvasholder">

  </div>


  
  <script>

function dlCanvas() {
    var dt = document.querySelector('canvas').toDataURL('image/png');
    this.href = dt;
};
dl.addEventListener('click', dlCanvas, false);

var stopstop = {};
stopstop.imagesReady = false;

stopstop.resizeStatic = function() {


    stopstop.map.position.x = renderer.width / 2;
    stopstop.map.position.y = renderer.height / 2;

    stopstop.red.width = renderer.width;
    stopstop.red.position.y = renderer.height;
    stopstop.red.position.x = renderer.width / 2;
};

stopstop.resizeText = function(){

    stopstop.warstate.position.y = renderer.height*0.85;
    stopstop.stopidet.position.y = renderer.height;
};


PIXI.loader.add('map', 'pics/mapa.png')
.add('red', 'pics/red.png')
.add('black', 'pics/cerne.png')
.add('stopidet', 'pics/STOPIDET.png')
.add('warstate', 'pics/warstate.png')
.add('disp', 'pics/disp.jpg')
.add('smoke1', 'pics/cloud1.png')
.add('smoke2', 'pics/cloud2.png')
.load(function(loader, resources) {

    // This creates a texture from a 'fence.png' image.
    stopstop.red = new PIXI.Sprite(resources.red.texture);
    stopstop.black = new PIXI.Sprite(resources.black.texture);
    stopstop.map = new PIXI.Sprite(resources.map.texture);
    stopstop.stopidet = new PIXI.Sprite(resources.stopidet.texture);
    stopstop.warstate = new PIXI.Sprite(resources.warstate.texture);
    stopstop.smoke1 = new PIXI.Sprite(resources.smoke1.texture);
    stopstop.smoke2 = new PIXI.Sprite(resources.smoke2.texture);
    stopstop.disp = new PIXI.Sprite(resources.disp.texture);




    stage.addChild(stopstop.map);
    stage.addChild(stopstop.red);
    stage.addChild(stopstop.warstate);
    stage.addChild(stopstop.stopidet);
    stage.addChild(stopstop.smoke1);
    stage.addChild(stopstop.smoke2);



    //setup static
    // Rotate around the center

    stopstop.warstate.anchor.set(0, 1);
    stopstop.warstate.scale.set(0.3, 0.3);

    stopstop.stopidet.anchor.set(0, 1);
    stopstop.stopidet.scale.set(0.3, 0.3);

    stopstop.stopidet.position.x = -stopstop.stopidet.width;
    stopstop.warstate.position.x = -stopstop.warstate.width;



    stopstop.map.anchor.set(0.5, 0.5);
    stopstop.map.scale.set(0.4, 0.4);

    stopstop.red.anchor.set(0.5, 1);

    // stopstop.smoke.blendMode = PIXI.BLEND_MODES.NORMAL;



    stopstop.resizeText();
    stopstop.resizeStatic();
    // stopstop.warstate.position.y = stopstop.h; 


    // // Add the map to the scene we are building.
    // stage.addChild(stopstop.map);
    // stage.addChild(stopstop.stopidet);

    // // Listen for frame updates
    // app.ticker.add(function() {
    //      // each frame we spin the bunny around a bit
    //      warstate.position.x = warstate.position.x + 1;
    //      smoke.position.x += 0.2;
    //      smoke.rotation += 0.001;

    // });
    stopstop.imagesReady = true;


});


var canvasholder = document.getElementById('canvasholder');
tools.mixin(tools, this);
// var w = canvasholder.offsetWidth;
// var h = canvasholder.offsetHeight;
stopstop.w = canvasholder.offsetWidth;
stopstop.h = canvasholder.offsetHeight;
var out = new Stage(stopstop.w, stopstop.h, false).out;

var webcam = new Webcam();
webcam.onError.add(function(){
  console.log('webcam inited');  
  webcam.init()
});//lol
webcam.onReady.add(onWebcam);
webcam.init();


var stage = new PIXI.Stage(0x66FF99);
var renderer = PIXI.autoDetectRenderer(stopstop.w, stopstop.h,{ preserveDrawingBuffer:true });


var texture = PIXI.Texture.fromCanvas(out.canvas);
var img = new PIXI.Sprite(texture);
stage.addChild(img);



var loop = new Loop(update, this, false);

var time = 0;

function onWebcam()
{
  console.log('onwebcam'); 
	loop.play();
	var w = webcam.video.width;
	var h = webcam.video.height;
	out.setTransform(-1, 0, 0, 1, w, 0);


	canvasholder.appendChild(renderer.view);

	window.onresize = onResize;
	onResize();
}

function update()
{
    // console.log('update'); 
	out.drawImage(webcam.video, 0, 0);

  if(stopstop.imagesReady) {
        stopstop.warstate.position.x -= 3;
        stopstop.stopidet.position.x += 5;
        //  stopstop.smoke.position.x += 0.2;
        //  stopstop.smoke.rotation += 0.0005;
  }

  if(stopstop.warstate.position.x < -stopstop.warstate.width) {stopstop.warstate.position.x = renderer.width}
  if(stopstop.stopidet.position.x > renderer.width) {stopstop.stopidet.position.x = -stopstop.stopidet.width}
    //updates webcam feed to stage 
    img.texture.update();
    renderer.render(stage);
}

function onResize()
{
	var w = canvasholder.offsetWidth;
	stopstop.w = canvasholder.offsetWidth;
	stopstop.h = canvasholder.offsetHeight;
	var h = canvasholder.offsetHeight;
	renderer.resize(w, h);

	var ww = webcam.video.width;
	var wh = webcam.video.height;

	var scale = 1;
	var ratio = ww / wh;
	if(ratio < w / h) scale = w / ww;
	else scale = h / wh;
	img.scale.x = img.scale.y = scale;
	img.position.x = 0.5 * (w - scale * ww);
	img.position.y = 0.5 * (h - scale * wh);


//resize texts



  stopstop.resizeText();
  stopstop.resizeStatic();
}









  </script>

</body>
</html>