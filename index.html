<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Warfie</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/4.5.1/pixi.min.js"></script>
  <!--<script type="text/javascript" src="lib/pixis.js"></script>-->
<script src="https://unpkg.com/jquery"></script>
  <script type="text/javascript" src="lib/tools.js"></script>
  <script type="text/javascript" src="lib/webcamz.js"></script>
  <script type="text/javascript" src="lib/color.js"></script>
  
  <style>


  #download {
    
  }
body, html {
  margin: 0;
  background-color: black;
}
  #canvasholder {
    position: relative;
    width: 100%;
    /*margin-left: 10%;*/
    margin-top: 40px;

    /*Výška musí být nastavená!!!*/
    height: 600px;
   height: 50vw;
    z-index: 5;
  }
  #mycamera {
    position: absolute;
    background-color: black;
    z-index: -1;
  }
  </style>


</head>

<body>
  <a id="dl" download="Stopidet.png" style="color: blue;">Download Canvas</a>
    <div id="canvasholder">

  </div>


  
  <script>

function dlCanvas() {
    var dt = document.querySelector('canvas').toDataURL('image/png');
    this.href = dt;
};
dl.addEventListener('click', dlCanvas, false);

var stopstop = {};
stopstop.imagesReady = false;

stopstop.setupStatic = function() {

  stopstop.smoke.anchor.x = 0.5;
  stopstop.smoke.anchor.y = 0.5;
  stopstop.smoke.scale.x = 3;
  stopstop.smoke.scale.y = 3;
  // stopstop.position.x = 0;


    // Setup the position of the fence
    stopstop.fence.x = stopstop.w / 2;
    stopstop.fence.width = stopstop.w;
    stopstop.fence.y = stopstop.h / 2;


};


PIXI.loader.add('fence', 'pics/fence.png')
.add('stopidet', 'pics/STOPIDET.png')
.add('warstate', 'pics/warstate.png')
.add('disp', 'pics/disp.jpg')
.add('smoke', 'pics/smoke.png')
.load(function(loader, resources) {

    // This creates a texture from a 'fence.png' image.
    stopstop.fence = new PIXI.Sprite(resources.fence.texture);
    stopstop.stopidet = new PIXI.Sprite(resources.stopidet.texture);
    stopstop.warstate = new PIXI.Sprite(resources.warstate.texture);
    stopstop.smoke = new PIXI.Sprite(resources.smoke.texture);
    stopstop.disp = new PIXI.Sprite(resources.disp.texture);


    stopstop.setupStatic();

    // Rotate around the center
    stopstop.fence.anchor.x = 0.5;
    stopstop.fence.anchor.y = 0.5;
    stopstop.warstate.position.y = stopstop.h; 


    stopstop.smoke.blendMode = PIXI.BLEND_MODES.SCREEN;
    // // Add the fence to the scene we are building.
    stage.addChild(stopstop.fence);
    // stage.addChild(stopstop.stopidet);
    stage.addChild(stopstop.warstate);
    stage.addChild(stopstop.smoke);

    // // Listen for frame updates
    // app.ticker.add(function() {
    //      // each frame we spin the bunny around a bit
    //      warstate.position.x = warstate.position.x + 1;
    //      smoke.position.x += 0.2;
    //      smoke.rotation += 0.001;

    // });
    stopstop.imagesReady = true;


});


var canvasholder = document.getElementById('canvasholder');
tools.mixin(tools, this);
// var w = canvasholder.offsetWidth;
// var h = canvasholder.offsetHeight;
stopstop.w = canvasholder.offsetWidth;
stopstop.h = canvasholder.offsetHeight;
var out = new Stage(stopstop.w, stopstop.h, false).out;

var webcam = new Webcam();
webcam.onError.add(function(){
  console.log('webcam inited');  
  webcam.init()
});//lol
webcam.onReady.add(onWebcam);
webcam.init();


var stage = new PIXI.Stage(0x66FF99);
var renderer = PIXI.autoDetectRenderer(stopstop.w, stopstop.h,{ preserveDrawingBuffer:true });


var texture = PIXI.Texture.fromCanvas(out.canvas);
var img = new PIXI.Sprite(texture);
stage.addChild(img);



var loop = new Loop(update, this, false);

var time = 0;

function onWebcam()
{
  console.log('onwebcam'); 
	loop.play();
	var w = webcam.video.width;
	var h = webcam.video.height;
	out.setTransform(-1, 0, 0, 1, w, 0);


	canvasholder.appendChild(renderer.view);

	window.onresize = onResize;
	onResize();
}

function update()
{
    // console.log('update'); 
	out.drawImage(webcam.video, 0, 0);

  if(stopstop.imagesReady) {
         stopstop.warstate.position.x += 1;
         stopstop.smoke.position.x += 0.2;
         stopstop.smoke.rotation += 0.0005;
  }
    //updates webcam feed to stage 
    img.texture.update();
    renderer.render(stage);
}

function onResize()
{
	// var w = window.innerWidth || document.body.clientWidth;
	// var h = window.innerHeight || document.body.clientHeight;

	var w = canvasholder.offsetWidth;
	stopstop.w = canvasholder.offsetWidth;
	stopstop.h = canvasholder.offsetHeight;
	var h = canvasholder.offsetHeight;
	renderer.resize(w, h);

	var ww = webcam.video.width;
	var wh = webcam.video.height;

	var scale = 1;
	var ratio = ww / wh;
	if(ratio < w / h) scale = w / ww;
	else scale = h / wh;
	img.scale.x = img.scale.y = scale;
	img.position.x = 0.5 * (w - scale * ww);
	img.position.y = 0.5 * (h - scale * wh);
    stopstop.fence.x = stopstop.w / 2;
    stopstop.fence.width = stopstop.w;
    stopstop.fence.y = stopstop.h / 2;

}









  </script>

</body>
</html>